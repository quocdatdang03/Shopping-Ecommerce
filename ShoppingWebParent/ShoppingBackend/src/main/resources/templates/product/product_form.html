<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      lang="en">
<head>
    <div th:replace="/fragment/fragments :: html_head(${pageTitle}, 'tag')">
    </div>

    <!-- rich text editor -->
    <link rel="stylesheet" th:href="@{/richtext/richtext.min.css}"/>
    <script type="text/javascript" th:src="@{/richtext/jquery.richtext.min.js}"></script>

    <style>
        .image-container {
            width: 100%; /* Đảm bảo container đầy đủ chiều rộng của cột */
            padding-top: 75%; /* Giữ tỷ lệ 1:1 cho hình ảnh, tương đương với hình vuông */
            position: relative; /* Đảm bảo phần tử con bên trong được định vị chính xác */
        }

        .image-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover; /* Đảm bảo hình ảnh không bị méo, cắt bớt nếu cần */
            max-width: 100%; /* Điều chỉnh kích thước tối đa */
            max-height: 300px;
        }

    </style>
</head>
<body>
<!-- Header -->
<div th:replace="/fragment/header :: admin_header">
</div>
<!-- END Header -->

<div class="container mt-5">
    <h1 class="mb-5">Manage Product | [[${pageTitle}]]</h1>
    <form th:action="@{/products/save}"
          enctype="multipart/form-data"
          th:object="${product}" method="POST"
          class="mx-auto rounded"
    >
        <nav>
            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#nav-overview" type="button" role="tab">Overview</button>
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#nav-description" type="button" role="tab">Description</button>
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#nav-images" type="button" role="tab">Images</button>
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#nav-details" type="button" role="tab">Details</button>
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#nav-shipping" type="button" role="tab">Shipping</button>
            </div>
        </nav>
        <div class="tab-content mt-3" id="nav-tabContent">
            <div class="tab-pane fade show active p-3" id="nav-overview" role="tabpanel">
                <div th:replace="product/fragment/product_overview :: content_overview">
                </div>
            </div>
            <div class="tab-pane fade p-3" id="nav-description" role="tabpanel">
                <div th:replace="product/fragment/product_description :: content_description">
                </div>
            </div>
            <div class="tab-pane fade p-3" id="nav-images" role="tabpanel">
                <div th:replace="product/fragment/product_images :: content_images">
                </div>
            </div>
            <div class="tab-pane fade p-3" id="nav-details" role="tabpanel">Details</div>
            <div class="tab-pane fade p-3" id="nav-shipping" role="tabpanel">
                <div th:replace="product/fragment/product_shipping :: content_shipping">
                </div>
            </div>
        </div>

        <div class="row mt-5 justify-content-center">
            <div class="col col-sm-3">
                <input type="submit" class="btn btn-primary p-2" style="width: 100%;" value="Save">
            </div>
            <div class="col col-sm-3">
                <a th:href="@{/products}" class="btn btn-secondary p-2" style="width: 100%;">Cancel</a>
            </div>
        </div>
    </form>

</div>

<!-- Footer -->
<div th:replace="/fragment/footer :: admin_footer">
</div>
<!-- End Footer -->


<!-- MODAL -->
<div class="modal fade" id="warningEmailModal">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 id="warningEmailModelTitle" class="modal-title fs-5"></h1>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="warningEmailModelMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    const brandsDropDown = $('#brandList');
    const categoriesDropDown = $('#categoryList');
    const defaultImageThumbnailSrc = "[[@{/images/img-thumbnail-default.jpg}]]";
    var extraImagesCount = 0;

    // using Jquery:
    $(document).ready(function () {

        // activate rich text editor:
        $('#shortDescription').richText();
        $('#fullDescription').richText();

        // handle set alias by default is product name (replace spaces by dashes - ) by when typing product Name:
        const productNameInput = $('#productName');
        const productAliasInput = $('#productAlias');

        productNameInput.on('input', function() {
            productAliasInput.empty();
            let productNameValue = productNameInput.val().trim();

            productAliasInput.val(productNameValue.replaceAll(" ", "-"));
        })


        // Handle Change Image when upload input type file:
        //      Handle when click image thumbnail -> input image file click
        $('#imgThumbnail').on('click', function() {
            $('#inputImageFile').click();
        })
        $('#inputImageFile').change(function() {
            // Nếu fileSize không thỏa mãn thì không làm gì cả
            if(checkFileSize(this)===false) {

                return "";
            }
            showImageThumbnail(this);
        })

        $('input[name="inputExtraImageFile"]').each(function(index) {
            extraImagesCount++;
            $(this).on('change', function() {
                showExtraImageThumbnail(this, index);
            })
        })


        // show chosen categories :
        const categories  = $('#categories')
        const chosenCategories = $('#chosenCategories');

        categories.on('change', function () {
            // clear chosenCategories in advanced :
            chosenCategories.empty();

            let selectedCategory = categories.children("option:selected");
            selectedCategory.each(function () {
                let categoryId = $(this).val()
                // replace -- to emtpty :
                let categoryName = $(this).text().replace(/--/g,"")

                chosenCategories.append("<span class='badge text-bg-dark mx-1'>"+categoryName+"</span>")
            })

        })


        // handle click brand dropdown show associated categories:
        brandsDropDown.on('change', function() {
            // clear brandsDropDown content in advanced :
            categoriesDropDown.empty();

            getAssociatedCategories();
        })

        // call first time to load associatedCategories to categoriesDropDown
        getAssociatedCategories();

    })

    // handle show associated categories of selected brand :
    function getAssociatedCategories() {
        let brandId = brandsDropDown.val();
        let url = "[[@{/brands/}]]"+brandId+"/categories";

        // ajax call GET request:
        $.get(url, function (response) {
            response.forEach(function (item) {
                const categoryId = item.id;
                const categoryName = item.name;
                // add associated categories of brand into categoriesDropDown :
                // Cách 1:
                // categoriesDropDown.append("<option value='"+categoryId+"'>"+categoryName+"</option>");
                // Cách 2 ngắn gọn hơn:
                $("<option>").val(categoryId).text(categoryName).appendTo(categoriesDropDown)
            })
        })
    }

    // Check file size:
    function checkFileSize(fileInput) {
        // Lấy ra file size
        var fileSize = fileInput.files[0].size
        alert(fileSize)
        // check if fileSize > 1MB (1048567) -> not accept:
        if(fileSize>1048567)
        {
            fileInput.setCustomValidity("file size must less than 1MB!")
            fileInput.reportValidity()
            return false
        }
        else {
            fileInput.setCustomValidity("")
            return true;
        }
    }

    // Handle Change Image when upload input type file:
    function showImageThumbnail(fileInput) {
        // Lấy ra đối tượng FileList :
        var file = fileInput.files[0];

        var fileReader = new FileReader();
        fileReader.readAsDataURL(file)

        fileReader.onload = function (e) {
            $('#imgThumbnail').attr("src", e.target.result)
        }
    }

    // Handle when click into image, it will show dialog of file input to choose file:
    function handleShowInputFileDialog(index) {
        $('#inputExtraImageFile'+index).click();
    }

    // Handle Change Extra Image when upload input type file:
    function showExtraImageThumbnail(fileInput, index) {
        // if file size is not eligible (false) -> do nothing:
        if(checkFileSize(fileInput)===false)
            return "";

        // Lấy ra đối tượng FileList :
        var file = fileInput.files[0];

        var fileReader = new FileReader();
        fileReader.readAsDataURL(file)

        fileReader.onload = function (e) {
            $('#extraImgThumbnail'+index).attr("src", e.target.result)
        }

        // Nếu là extra images cuối cùng thì mới addNextExtraImage :
        if(index >= extraImagesCount-1)
            addNextExtraImage(index+1);
    }

    // add next extra image:
    function addNextExtraImage(index) {
        const htmlExtraImage = `
            <div class="col text-center" id="divExtraImage${index}">
                <div id="extraImageHeader${index}" class="d-flex justify-content-center align-items-center">
                     <label class="form-label badge text-bg-secondary fs-5">Extra Image #${index+1}</label>
                </div>
                <div class="image-container mt-1 mb-2">
                    <img id="extraImgThumbnail${index}" onclick="handleShowInputFileDialog(${index})" class="img-fluid" src="${defaultImageThumbnailSrc}" alt="" style="cursor: pointer;"/>
                </div>
                <input name="inputExtraImageFile" id="inputExtraImageFile${index}" type="file" class="form-control" onchange="showExtraImageThumbnail(this, ${index})" accept="image/png, image/jpeg"/>
             </div>
        `;

        // Chỉ hiển thị button remove với các extra image không phải là cuối cùng
        // add button remove vào extra image trước extra image vừa mới được thêm vào
        const htmlBtnRemove = `
            <div class="btn fa-solid fa-trash fa-2x text-danger"
                onclick="removeExtraImage(${index - 1})"
                title="Remove this image">
            </div>
	    `;



        $('#divProductImage').append(htmlExtraImage);

        // add button remove vào extra image trước extra image vừa mới được thêm vào
        $("#extraImageHeader" + (index - 1)).append(htmlBtnRemove);

        extraImagesCount++;
    }

    // remove extra image
    function removeExtraImage(index) {
        $("#divExtraImage" + index).remove();
    }

</script>
</body>
</html>